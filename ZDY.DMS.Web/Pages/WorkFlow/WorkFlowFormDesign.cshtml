@page
@model ZDY.DMS.Web.Pages.WorkFlow.WorkFlowFormDesign
@{
    ViewData["Title"] = "FormDesign";
}

<div class="row">
    <div class="col-md-12">
        <portlet title="表单设计" is-fit="true">
            <div class="row margin-bottom-20" data-model="settings">
                <div class="col-md-12">
                    <div class="btn-group">
                        <button icon="FolderOpen" color="GreenJungle" bs-toggle-modal="modal-table">
                            打开表单
                        </button>
                        <button icon="Plus" color="BlueSharp" bs-toggle-modal="modal-new" data-bind="click:handleResetNewName">
                            新建表单
                        </button>
                    </div>
                    <div class="btn-group" data-bind="visible: ID() != 0">
                        <button icon="Edit" color="YellowSaffron" bs-toggle-modal="modal-settings">
                            表单设置
                        </button>
                    </div>
                    <div class="btn-group" data-bind="visible: ID() != 0">
                        <button icon="Empire" color="Red" data-bind="click:handleClearForm">
                            清空表单
                        </button>
                    </div>
                    <div class="btn-group" data-bind="visible: ID() != 0">
                        <button icon="Save" color="BlueChambray" data-bind="click:handleSaveForm">
                            保存表单
                        </button>
                        <button icon="ShareAlt" color="BlueHoki" bs-toggle-modal="modal-save-as" data-bind="click:handleResetNewName">
                            另存表单
                        </button>
                    </div>
                    <div class="btn-group" data-bind="visible: ID() != 0">
                        <button icon="Upload" color="PurpleMedium" data-bind="click:handlePublishForm">
                            发布表单
                        </button>
                        <button icon="Download" color="GreenJungle" data-bind="click:handleRePublishForm">
                            回退发布
                        </button>
                        <button icon="Remove" color="RedPink" data-bind="click:$root.delete">
                            删除流程
                        </button>
                    </div>
                </div>
            </div>
            <hr />
            <div class="row">
                <div class="col-md-12">
                    <div id="fb-editor"></div>
                </div>
            </div>
        </portlet>
    </div>
</div>

<div data-model="settings">
    <modal title="新建流程" id="modal-new">
        <modal-body>
            <div class="row">
                <div class="col-md-12">
                    <form-builder>
                        <div class="row">
                            <div class="col-md-12">
                                <text-box field="NewName" name="流程名称"></text-box>
                            </div>
                        </div>
                    </form-builder>
                </div>
            </div>
        </modal-body>
        <modal-footer dismiss-text="关闭">
            <button type="button" class="btn green" data-bind="click:handleNewForm">提交</button>
        </modal-footer>
    </modal>

    <modal title="流程设置" size="Lg" id="modal-settings">
        <modal-body>
            <div class="row">
                <div class="col-md-12">
                    <form-builder>
                        <div class="row">
                            <div class="col-md-6">
                                <text-box field="Name" name="表单名称" is-required="true"></text-box>
                            </div>
                            <div class="col-md-6">
                                <select-box field="Type" name="表单类型" options="@Model.WorkFlowFormKinds" is-use-place-holder="false"></select-box>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <text-box field="Note" name="备注信息" is-multiple="true"></text-box>
                            </div>
                        </div>
                    </form-builder>
                </div>
            </div>
        </modal-body>
        <modal-footer dismiss-text="关闭">
            <button type="button" class="btn green" data-bind="click:update, visible:ID()!=0">修改</button>
        </modal-footer>
    </modal>

    <modal title="另存流程" id="modal-save-as">
        <modal-body>
            <div class="row">
                <div class="col-md-12">
                    <form-builder>
                        <div class="row">
                            <div class="col-md-12">
                                <text-box field="NewName" name="新流程名称"></text-box>
                            </div>
                            <div class="col-md-12">
                                <check-box field="IsOpenAfter" name="另存后立即打开"></check-box>
                            </div>
                        </div>
                    </form-builder>
                </div>
            </div>
        </modal-body>
        <modal-footer dismiss-text="关闭">
            <button type="button" class="btn green" data-bind="click:handleSaveAsForm">提交</button>
        </modal-footer>
    </modal>
</div>
<div data-model="table">
    <modal title="打开表单" size="Lg" id="modal-table">
        <modal-body>
            <div class="row">
                <div class="col-md-8">
                    <data-table is-show-checkbox-column="false" style="margin: 0px !important;">
                        <td data-bind="text:Name"></td>
                        <td data-bind="text:CreateTime"></td>
                        <td>
                            <lable data-bind="state:$root.dic('WorkFlowFormKinds', Type, true)"></lable>
                        </td>
                        <td>
                            <lable data-bind="state:$root.dic('WorkFlowFormState', State, true)"></lable>
                        </td>
                        <td>
                            <button size="Xs" color="RedHaze" data-bind="click:$root.handleSelected">加载</button>
                        </td>
                    </data-table>
                    <pager></pager>
                </div>
                <div class="col-md-4">
                    <form-builder>
                        <div class="row">
                            <div class="col-md-12">
                                <text-box field="Name" name="表单名称"></text-box>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <select-box field="Type" name="表单类型" options="@Model.WorkFlowFormKinds"></select-box>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <button color="Green" data-bind="click:firstPage">点击查询</button>
                            </div>
                        </div>
                    </form-builder>
                </div>
            </div>
        </modal-body>
    </modal>
</div>

@section Styles{
    <style type="text/css">
        .form-wrap.form-builder .frmb-control li {
            width: 100%;
        }

        .form-wrap.form-builder .frmb .sortable-options .option-selected {
            width: 20px !important;
            float: left;
            margin-top: 6px !important;
        }

        .form-wrap.form-builder .frmb .form-elements .false-label:first-child,
        .form-wrap.form-builder .frmb .form-elements label:first-child {
            font-weight: normal !important;
        }

        .form-wrap.form-builder .frmb .form-elements .available-roles input {
            display: inline-block !important;
        }

        .form-wrap.form-builder .form-group.fb-file input[type=file] {
            border: none;
            padding: 6px 0px;
        }

        .form-wrap.form-builder .frmb .form-elements .input-wrap > input[type=checkbox] + label,
        .form-wrap.form-builder .fb-radio-group .radio-inline input + label,
        .form-wrap.form-builder .fb-checkbox-group .checkbox-inline input + label,
        .form-wrap.form-builder .frmb .form-field .form-group.access-wrap .fld-access + label {
            margin-bottom: 1px;
        }
    </style>
}

@section Scripts{
    <script type="text/javascript">
        var dictionary = JSON.parse('@Html.Raw(JsonConvert.SerializeObject(Model.Dictionary))')

        require([
            "jquery",
            "ko",
            "zdy",
            "app",
            "bootstrap",
            "form-builder",
            ui], function ($, ko, zdy, app) {

                var ui = arguments[arguments.length - 1];
                ui.init();

                var initDesigner = function () {
                    var formBuilder = $(document.getElementById('fb-editor')).formBuilder({
                        showActionButtons: false
                    });

                    return {
                        clear: function () {
                            formBuilder.actions.clearFields();
                        },
                        getJson: function () {
                            return formBuilder.actions.getData('json', true);
                        },
                        load: function (data) {
                            formBuilder.actions.setData(data);
                        }
                    }
                }

                var designer = initDesigner();

                var settings = zdy.form().options({
                    fields: [
                        { field: 'ID', value: ko.observable(0) },
                        { field: 'Name', value: ko.observable() },
                        { field: 'Type', value: ko.observable() },
                        { field: 'Note', value: ko.observable() }
                    ],
                    dataAddUrl: 'WorkFlowForm/Add',
                    dataUpdateUrl: 'WorkFlowForm/Update',
                    dataDeleteUrl: 'WorkFlowForm/Delete'
                }).import(function () {

                    this.afterAdd = function (data) {
                        this.ID(data.ID)
                        designer.clear()
                        $("#modal-new").modal("hide")
                    }

                    this.afterDelete = function () {
                        this.reset()
                        designer.clear()
                    }

                    this.NewName = ko.observable("")
                    this.IsOpenAfter = ko.observable(false)

                    this.handleResetNewName = function () {
                        this.NewName("")
                        this.IsOpenAfter(false)
                    }

                    this.handleClearForm = function () {
                        designer.clear()
                    }

                    this.handleNewForm = function () {
                        var name = this.NewName()
                        if (name != "" && name != undefined) {
                            this.reset()
                            this.ID(0)
                            this.Name(name)
                            this.add()
                        } else {
                            zdy.toastr.success("请填写表单名称");
                        }
                    }

                    this.handleSaveForm = function () {
                        var designJson = designer.getJson()
                        var id = this.ID()
                        var designFieldJson = this.handleGetFieldJson()
                        zdy.ajaxPost("WorkFlowForm/SaveForm", { id: id, designJson: designJson, designFieldJson: designFieldJson }).done(function (rst) {
                            if (rst.IsSuccess) {
                                zdy.toastr.success("保存成功");
                            }
                        })
                    }

                    this.handleSaveAsForm = function () {
                        var designJson = designer.getJson()
                        var id = this.ID()
                        var designFieldJson = this.handleGetFieldJson()
                        var name = this.NewName()
                        var isOpen = this.IsOpenAfter()
                        zdy.ajaxPost("WorkFlowForm/SaveAsForm", { id: id, name: name, designJson: designJson, designFieldJson: designFieldJson }).done(function (rst) {
                            if (rst.IsSuccess) {
                                if (isOpen) {
                                    settings.handleLoadForm(rst.Data.ID)
                                }
                                $("#modal-save-as").modal("hide")
                                zdy.toastr.success("另存成功");
                            }
                        })
                    }

                    this.handlePublishForm = function () {
                        var designJson = designer.getJson()
                        var id = this.ID()
                        var designFieldJson = this.handleGetFieldJson()
                        zdy.ajaxPost("WorkFlowForm/PublishForm", { id: id, designJson: designJson, designFieldJson: designFieldJson }).done(function (rst) {
                            if (rst.IsSuccess) {
                                zdy.toastr.success("发布成功");
                            }
                        })
                    }

                    this.handleRePublishForm = function () {
                        var id = this.ID()
                        zdy.ajaxPost("WorkFlowForm/RePublishForm", { id: id }).done(function (rst) {
                            if (rst.IsSuccess) {
                                zdy.toastr.success("回退成功");
                            }
                        })
                    }

                    this.handleGetFieldJson = function () {
                        var designJson = designer.getJson()
                        var data = JSON.parse(designJson);
                        var rst = []
                        if (data && data.length > 0) {
                            data.map(function (item) {
                                if (item.name) {
                                    rst.push({
                                        field: item.name,
                                        name: item.label
                                    })
                                }
                            })
                        }
                        return JSON.stringify(rst)
                    }

                    this.handleLoadForm = function (id) {
                        zdy.ajaxPost("WorkFlowForm/FindById", { id: id }).done(function (rst) {
                            if (rst.IsSuccess) {
                                settings.load(rst.Data)

                                if (rst.Data.DesignJson.length > 0) {
                                    try {
                                        designer.load(rst.Data.DesignJson)
                                    } catch (e) {
                                        designer.clear()
                                    }
                                } else {
                                    designer.clear()
                                }

                                zdy.toastr.success("加载完成");
                            }
                        })
                    }

                }).bind("settings");

                var table = zdy.table().options({
                    fields: [
                        { field: 'Name', value: ko.observable(), method: zdy.querymethod.contains },
                        { field: 'Type', value: ko.observable(), method: zdy.querymethod.equal }
                    ],
                    headers: [
                        { text: '表单名称', field: 'Name' },
                        { text: '创建时间', field: 'CreateTime' },
                        { text: '表单类型', field: 'Type' },
                        { text: '表单状态', field: 'State' }
                    ],
                    pageSize: 10,
                    defaultOrderBy: "ID",
                    dataQueryUrl: 'WorkFlowForm/List'
                }).import(function () {

                    this.dic(dictionary)

                    this.handleSelected = function (item) {
                        $("#modal-table").modal("hide")

                        settings.handleLoadForm(item.ID)
                    }

                }).bind("table").load();
            })
    </script>
}