define(["zrender"],function(n){function c(n){function u(n,t){if(t=t.replace(/\{|\(|\)|\}|-/g,""),t=t.toLowerCase(),t.length!=32||t.search(/[^0-9,a-f]/i)!=-1)r(n);else for(var i=0;i<t.length;i++)n.push(t[i])}function r(n){for(var t=32;t--;)n.push("0")}function i(n,t){var r;switch(t){case"N":return n.toString().replace(/,/g,"");case"D":return r=n.slice(0,8)+"-"+n.slice(8,12)+"-"+n.slice(12,16)+"-"+n.slice(16,20)+"-"+n.slice(20,32),r.replace(/,/g,"");case"B":return r=i(n,"D"),"{"+r+"}";case"P":return r=i(n,"D"),"("+r+")";default:return new c}}var t=[];typeof n=="string"?u(t,n):r(t);this.Equals=function(n){return n&&n.IsGuid?this.ToString()==n.ToString():!1};this.IsGuid=function(){};this.ToString=function(n){return typeof n=="string"?n=="N"||n=="D"||n=="B"||n=="P"?i(t,n):i(t,"D"):i(t,"D")}}function l(){for(var n="",t=32;t--;)n+=Math.floor(Math.random()*16).toString(16);return new c(n)}function w(){function d(n){for(var r=t.getActivityTransitions(n),i=0;i<r.length;i++)r[i].refresh()}function g(n){var t=n.event;c&&d(c);r&&r.updateMiddlePoint(s,t.zrX,t.zrY).clearMovement().refresh()}var h=document.getElementById("canvas"),t=this,o={},u={},f,e,c,r,s,p,w,a,k,b;this.zrenderInstance=function(){return f};this.newGuid=function(){var n=l().ToString();return(o[n]!=undefined||u[n]!=undefined)&&(n=t.newGuid()),n};this.addActivity=function(n){o[n.id]=n};this.removeActivity=function(n){delete o[n]};this.getActivity=function(n){return o[n]==undefined?undefined:o[n]};this.getActivities=function(){var n=[];for(var t in o)n.push(this.getActivity(t));return n};this.clearActivity=function(){o={}};this.addTransition=function(n){u[n.id]=n};this.removeTransition=function(n){delete u[n]};this.getTransition=function(n){return u[n]==undefined?undefined:u[n]};this.getTransitions=function(){var n=[];for(var t in u)n.push(this.getTransition(t));return n};this.clearTransition=function(){u={}};this.connectActivitys={activities:[],subtype:1,isWaiting:function(){return this.activities.length>0},setType:function(n){return this.subtype=n,this},clear:function(){return this.subtype=1,this.activities=[],this},add:function(n){return this.activities.push(n),this},done:function(){if(this.activities.length==2){var n={id:l().ToString(),from:this.activities[0].id,fromAngle:-5,to:this.activities[1].id,toAngle:-1,title:"无条件",subtype:this.subtype},i=v(n);i.drawTo(t)}this.activities=[]}};y.apply(this);this.contextMenuItems=[];this.contextMenuItems.push(new i({text:"新建步骤",action:"add",source:{graph:this}}));this.contextMenuItems.push(new i({text:"新建子流程",action:"add2",source:{graph:this}}));this.contextMenuItems.push(new i({text:"清空画布",action:"clear",source:{graph:this}}));c=null;this.onActivityDragStart=function(n,t){c=t};this.onActivityDragEnd=function(){c&&d(c);c=null};this.getActivityTransitions=function(n){var i=n.id,r=[],f,t;for(f in u)t=u[f],(t.from===i||t.to==i)&&r.push(t);return r};r=null;s=-1;this.onTransitionDragStart=function(n,t){r=n;p={x:t.clientX,y:t.clientY};s=n.addMiddlePoint(t.clientX,t.clientY)};this.onTransitionDragEnd=function(n){var t,i;r&&(r.refresh(),t=Math.sqrt((n.clientX-p.x)*(n.clientX-p.x)+(n.clientY-p.y)*(n.clientY-p.y)),t>8?i=r.middlePoints[s]:r.deleteMiddlePoint(s).refresh(),r=null,s=-1)};this.onTransitionMiddlePointDragStart=function(n,t){r=n;s=t};this.onTransitionMiddlePointDragEnd=function(){if(r){r.refresh();var n=r.middlePoints[s];r=null;s=-1}};w=null;this.onUnitSelect=function(n,t){w&&w.unselect();t.select();w=t};a=null;this.onUnitMouseOver=function(n,t){a=t};this.onUnitMouseOut=function(n,t){a===t&&(a=null)};this.onContextMenu=function(n){return a?a.showContextMenu(n,e,t):t.showContextMenu(n,e,t),!1};this.handleWheel=function(n){var u,i,t,r;if(n?this.scale+=.2:this.scale-=.2,this.scale<.5||this.scale>3){this.scale<.5?this.scale=.5:this.scale>3&&(this.scale=3);return}for(u=this.zrenderInstance().storage,i=this.zrenderInstance().storage.getDisplayList(!0,!0),t=0;t<i.length;t++)r=i[t],r.tag!="tool"&&r.attr("scale",[this.scale,this.scale]);this.zrenderInstance().refresh()};this.useWheel=function(){if(!t.designable){var n=new ut;n.addTo(t)}};this.useMove=function(){if(!t.designable){f.on("mousedown",function(n){b=[n.event.zrX,n.event.zrY];k=!0});f.on("mouseup",function(){k=!1});f.on("mousemove",function(n){var i,t;if(k){var u=n.event.zrX-b[0],e=n.event.zrY-b[1],r=f.storage.getDisplayList(!0,!0);for(i=0;i<r.length;i++)t=r[i],t.tag!="tool"&&(t.position[0]=t.position[0]+u,t.position[1]=t.position[1]+e,t.dirty());f.refresh();b=[n.event.zrX,n.event.zrY]}})}};this.init=function(i){if(i!=undefined&&(this.offsetX=i.offsetX||h.offsetLeft,this.offsetY=i.offsetY||h.offsetTop,this.fontFamily=i.fontFamily||"Microsoft YaHei",this.designable=i.designable||!1,this.scale=i.scale||1,this.activityDataModel=i.activityDataModel||{},this.transitionDataModel=i.transitionDataModel||{},this.onUnitClick=i.onUnitClick,this.onUnitDblclick=i.onUnitDblclick,this.onUnitSetting=i.onUnitSetting),h.style.height=(i.height||600)+"px",f=n.init(h),this.designable){e=document.createElement("div");e.className="context-menu";e.style.display="none";h.appendChild(e);e.onmouseleave=function(){e.style.display="none"};e.onclick=function(){e.style.display="none"};f.on("mousemove",g);h.oncontextmenu=t.onContextMenu}else h.oncontextmenu=function(){return!1},this.useMove()};this.add=function(n){f.add(n)};this.remove=function(n){f.remove(n)};this.clear=function(){f.clear();t.clearActivity();t.clearTransition();t.connectActivitys.clear();t.useWheel()};this.refresh=function(){var t,n,i;for(n in u)t=u[n],t.refresh();for(n in o)i=o[n],i.refresh();this.zrenderInstance().refresh()}}function a(n){y.apply(this);var t=this;this.contextMenuItems=[];this.id=n.id;this.title=n.title;this.data=n.data;this.clickable=n.clickable==undefined?!0:n.clickable;this.graph=null;this.element=null;this.selected=!1;this.createShapeOptions=function(){return{id:t.id,scale:[t.graph.scale,t.graph.scale],onclick:function(n){if(t.graph.designable)t.graph.onUnitSelect(n,t);if(t.type=="Activity"&&t.graph.connectActivitys.isWaiting()&&t.graph.connectActivitys.add(t).done(),typeof t.graph.onUnitClick=="function"&&t.clickable==!0)t.graph.onUnitClick(n,t)},ondblclick:function(n){if(typeof t.graph.onUnitDblclick=="function"&&t.clickable==!0)t.graph.onUnitDblclick(n,t)},onmouseover:function(n){if(t.graph.designable)t.graph.onUnitMouseOver(n,t)},onmouseout:function(n){if(t.graph.designable)t.graph.onUnitMouseOut(n,t)}}};this.addTo=function(){};this.drawTo=function(n){this.graph=n;this.type=="Transition"?n.addTransition(this):this.type=="Activity"&&n.addActivity(this);this.addTo(n)};this.remove=function(){};this.refresh=function(){return[]};this.select=function(){return this.selected=!0,this.refresh()};this.unselect=function(){return this.selected=!1,this.refresh()}}function e(n,t,i){function o(n,t){return{shape:{cx:t.x,cy:t.y,r:8},style:{fill:"#fdc",stroke:"#fff",lineWidth:2},ondrop:function(){u=!0;e(n)}}}function e(n){var r=t.fromAngle,u=t.toAngle;(i?r=n:u=n,r!==t.fromAngle||u!==t.toAngle)&&(t.fromAngle=r,t.toAngle=u,t.clearMovement().refresh())}var s=n.graph,f=[],u=!1;this.start=function(t){for(var u,i=1;i<=8;i++)u=new r(o(i,n.getAnglePosition(i))),t.add(u),f.push(u)};this.end=function(n){u||e(0);u=!1;f.each(function(t){n.remove(t)})}}function o(n){a.apply(this,arguments);var u=this;this.color={ACTIVITY_COLOR:"rgba(215, 249, 255, 0.6)",ACTIVITY_STROKE_COLOR:"#999",ACTIVITY_TEXT_COLOR:"#333",ACTIVITY_SELECTED_COLOR:"rgba(255, 102, 51, 0.6)",ACTIVITY_INSTANCE_COLOR:"rgba(221, 221, 221, 0.8)",ACTIVITY_INSTANCE_INACTIVE_COLOR:"rgba(39, 104, 234, 0.8)",ACTIVITY_INSTANCE_ACTIVE_COLOR:"rgba(244, 208, 63, 0.8)",ACTIVITY_INSTANCE_SUSPENDED_COLOR:"rgba(231, 80, 90, 0.8)",ACTIVITY_INSTANCE_COMPLETED_COLOR:"rgba(38, 194, 129, 0.8)",getActivityArchiveColor:function(n){switch(n){case 0:return u.color.ACTIVITY_INSTANCE_INACTIVE_COLOR;case 1:return u.color.ACTIVITY_INSTANCE_ACTIVE_COLOR;case 2:return u.color.ACTIVITY_INSTANCE_SUSPENDED_COLOR;case 3:return u.color.ACTIVITY_INSTANCE_COMPLETED_COLOR;default:return u.color.ACTIVITY_INSTANCE_COLOR}}};this.type=n.type||"Activity";this.status=n.status||undefined;this.position=n.position||{x:0,y:0};this.angleTargets=new e(this);this.contextMenuItems=[];this.contextMenuItems.push(new i({text:"条件链接",action:"join",source:this}));this.contextMenuItems.push(new i({text:"配置节点",action:"setting",source:this}));this.contextMenuItems.push(new i({text:"删除节点",action:"remove",source:this}));this.getAnglePosition=function(){};this.getCurrentPosition=function(){var n=this.element.position,t=this.element.shape;return{x:t.x+n[0],y:t.y+n[1]}};this.createActivityOptions=function(){var n=this,i=n.graph,r=this.createShapeOptions();return t.merge(r,{shape:{x:n.position.x,y:n.position.y},style:{fill:i.designable?n.color.ACTIVITY_COLOR:n.color.getActivityArchiveColor(n.status),stroke:n.color.ACTIVITY_STROKE_COLOR,lineWidth:1,fontFamily:i.fontFamily,text:n.title,textPosition:"inside",textFill:n.color.ACTIVITY_TEXT_COLOR,transformText:!0},draggable:i.designable,ondragstart:function(t){i.onActivityDragStart(t,n)},ondragend:function(t){i.onActivityDragEnd(t,n)}})};this.createAngleTargets=function(){for(var n,u,f,t=this,o=t.graph,e=[],i=1;i<=8;i++)n=t.createShapeOptions(),n.shape.r=5,n.style.text="",u=t.getAnglePosition(i),n.shape.cx=u.x,n.shape.cy=u.y,f=new r(n),o.add(f),e.push(f);return e};this.getMaxCoords=function(){return this.getCurrentPosition()};this.remove=function(){var t,n;for(this.graph.remove(this.element),this.graph.removeActivity(this.id),t=this.graph.getActivityTransitions(this),n=0;n<t.length;n++)t[n].remove()}}function s(){o.apply(this,arguments);this.r=30;this.subtype=0;this.getAnglePosition=function(n){var t=this.r,i=this.element.position,r=this.element.shape,f=this.element.style,u=Math.PI/180*((n+2)%8)*45;return{x:Math.round(r.cx+i[0]+Math.sin(u)*t),y:Math.round(r.cy+i[1]+Math.cos(u)*t)}};this.createCircleOptions=function(n){var i=this,t=i.createActivityOptions();return t.shape.cx=t.shape.x,t.shape.cy=t.shape.y,t.shape.r=30,n&&(t.style.fill=i.color.ACTIVITY_SELECTED_COLOR),t};this.getMaxCoords=function(){var n=this.getCurrentPosition();return{x:n.x+this.r,y:n.y+this.r}};this.addTo=function(n){var u=this,f=n.activityDataModel,e=u.createCircleOptions(!1),i;this.element=new r(e);n.add(this.element);i=new f(u);this.data=this.data?t.merge(this.data,i):i};this.refresh=function(){var n=this,t=n.createCircleOptions(n.selected);return n.element.setStyle(t.style),[n.element]}}function b(){o.apply(this,arguments);this.width=110;this.height=60;this.delta=20;this.subtype=1;this.buildPointList=function(n,t,i){var o=this.position,r=o.x,u=o.y,f=t/2,e=(n+i)/2,s=[r-e+i,u-f],h=[r+e,u-f],c=[r+e-i,u+f],l=[r-e,u+f];return[s,h,c,l]};this.getAnglePosition=function(n){var r=this,e=r.element.position,c=r.element.style,o=r.element.shape,t=o.x+e[0],i=o.y+e[1],s=r.width/2,f=(r.width+r.delta)/2,u=r.height/2,h=r.delta;switch(n){case 1:t=t-f+h;i=i-u;break;case 2:i=i-u;break;case 3:t=t+f;i=i-u;break;case 4:t=t+s;break;case 5:t=t+f-h;i=i+u;break;case 6:i=i+u;break;case 7:t=t-f;i=i+u;break;case 8:t=t-s}return{x:t,y:i}};this.createPolygonOptions=function(n){var t=this,i=t.createActivityOptions();return i.shape.points=t.buildPointList(t.width,t.height,t.delta),i.shape.smooth="0.2",n&&(i.style.fill=t.color.ACTIVITY_SELECTED_COLOR),i};this.getMaxCoords=function(){var n=this.getCurrentPosition();return{x:n.x+(this.width+this.delta)/2,y:n.y+this.height/2}};this.addTo=function(n){var r=this,u=n.activityDataModel,f=r.createPolygonOptions(!1),i;this.element=new h(f);n.add(this.element);i=new u(r);this.data=this.data?t.merge(this.data,i):i};this.refresh=function(){var n=this,t=n.createPolygonOptions(n.selected);return n.element.setStyle(t.style),[n.element]}}function k(){o.apply(this,arguments);this.width=120;this.height=70;this.subtype=2;this.getAnglePosition=function(n){var t=this,i=t.element.position,h=t.element.style,r=t.element.shape,f=r.x+i[0],e=r.y+i[1],o=t.width/2,s=t.height/2,u=[[],[0,0],[1,0],[2,0],[2,1],[2,2],[1,2],[0,2],[0,1]];return{x:f+u[n][0]*o,y:e+u[n][1]*s}};this.createRectangleOptions=function(n){var t=this,u=t.position,r=t.createActivityOptions(),f=r.style,i=r.shape;return i.x=u.x-t.width/2,i.y=u.y-t.height/2,i.width=t.width,i.height=t.height,i.r=3,n&&(r.style.fill=t.color.ACTIVITY_SELECTED_COLOR),r};this.getCurrentPosition=function(){var n=this,t=n.element.position,r=n.element.style,i=n.element.shape;return{x:i.x+n.width/2+t[0],y:i.y+n.height/2+t[1]}};this.getMaxCoords=function(){var n=this.getCurrentPosition();return{x:n.x+this.width/2,y:n.y+this.height/2}};this.addTo=function(n){var r=this,u=n.activityDataModel,e=r.createRectangleOptions(!1),i;this.element=new f(e);n.add(this.element);i=new u(r);this.data=this.data?t.merge(this.data,i):i};this.refresh=function(){var n=this,t=n.createRectangleOptions(n.selected);return n.element.setStyle(t.style),[n.element]}}function d(n){var t;switch(n.subtype){case 0:t=new s(n);break;case 1:t=new b(n);break;case 2:t=new k(n)}return t}function g(n){a.apply(this,arguments);this.color={TRANSITION_STROKE_COLOR:"#999",TRANSITION_SELECTED_STROKE_COLOR:"#f63",TRANSITION_COLOR_FIXED:"#bbb",TRANSITION_COLOR_UNFIXED:"#eee",TRANSITION_SELECTED_COLOR_FIXED:"#f96",TRANSITION_SELECTED_COLOR_UNFIXED:"#fdc"};this.id=n.id;this.title=n.title;this.type=n.type||"Transition";this.subtype=n.subtype||0;this.from=n.from;this.fromAngle=n.fromAngle;this.fromAngleRun=null;this.to=n.to;this.toAngle=n.toAngle;this.toAngleRun=null;this.middlePoints=n.middlePoints||[];this.polyline=null;this.arrow=null;this.circle=null;this.contextMenuItems=[];this.contextMenuItems.push(new i({text:"配置连线",action:"setting",source:this}));this.contextMenuItems.push(new i({text:"删除连线",action:"remove",source:this}));this.calculteMiddlePointPositions=function(n,t){function u(i){var f=(t.x-n.x)*i.h+n.x,e=(t.y-n.y)*i.h+n.y,o=t.x,s=t.y,u=r*i.v,h,c;return i.h>1&&(u=-u),h=f-u*Math.sin(Math.atan2(s-e,o-f)),c=e+u*Math.cos(Math.atan2(s-e,o-f)),[h,c]}var r=Math.sqrt(Math.pow(n.x-t.x,2)+Math.pow(n.y-t.y,2)),i=[];return this.middlePoints.each(function(n){i.push(u(n))}),i};this.createPolylineOptions=function(n){function l(n,t){for(var u,f=-1,r=0,e=null,i=1;i<=8;i++)u=t.getAnglePosition(i),distance=Math.sqrt(Math.pow(n.x-u.x,2)+Math.pow(n.y-u.y,2)),(f===-1||distance<r||Math.abs(distance-r)<a&&i%2==0)&&(f=i,r=distance,e=u);return{angleIndex:f,distance:r,position:e}}function v(n,t){for(var e,r,f=-1,u=0,o=null,s=null,i=1;i<=8;i++)e=n.getAnglePosition(i),r=l(e,t),(f===-1||r.distance<u||Math.abs(r.distance-u)<a&&i%2==0)&&(f=i,u=r.distance,o=e,s=r);return[{angleIndex:f,position:o,distance:u},s]}var i=this,f=this.graph,a=15,s=f.getActivity(i.from),h=f.getActivity(i.to),r,u,o,e,c;return i.fromAngle<1||i.fromAngle>8?i.toAngle<1||i.toAngle>8?(o=v(s,h),r=o[0].position,i.fromAngleRun=o[0].angleIndex,u=o[1].position,i.toAngleRun=o[1].angleIndex):(u=h.getAnglePosition(i.toAngle),e=l(u,s),r=e.position,i.fromAngleRun=e.angleIndex):i.toAngle<1||i.toAngle>8?(r=s.getAnglePosition(i.fromAngle),e=l(r,h),u=e.position,i.toAngleRun=e.angleIndex):(r=s.getAnglePosition(i.fromAngle),u=h.getAnglePosition(i.toAngle)),c=r.x===u.x&&r.y===u.y?[]:i.calculteMiddlePointPositions(r,u),c.splice(0,0,[r.x,r.y]),c.push([u.x,u.y]),i.choosePolylineStyle(),t.merge(i.createShapeOptions(),{shape:{points:c,smooth:"spline"},style:{stroke:n?"#f63":"#888",lineWidth:i.polylineStyleLineWidth,lineDash:i.polylineStyleLineDash,text:i.title,fontFamily:f.fontFamily,textPosition:"inside",transformText:!0},draggable:f.designable,ondragstart:function(n){f.onTransitionDragStart(i,n.event)},ondragend:function(n){f.onTransitionDragEnd(n.event)}})};this.polylineStyleLineDash=[5,5];this.polylineStyleLineWidth=3;this.choosePolylineStyle-function(){};this.getColor=function(n,t){var i=this,u=this.graph.designable,r=t||!u;return n?r?i.color.TRANSITION_SELECTED_COLOR_UNFIXED:i.color.TRANSITION_SELECTED_COLOR_FIXED:r?i.color.TRANSITION_COLOR_UNFIXED:i.color.TRANSITION_COLOR_FIXED};this.toAngleTargets=null;this.getToAngleTargets=function(){return this.toAngleTargets||(this.toAngleTargets=new e(this.graph.getActivity(this.to),this,!1))};this.createArrowOptions=function(n){var i=this,e=this.graph,a=i.toAngle<1||i.toAngle>8,u=i.polyline.shape.points,o=u[u.length-2],s={x:o[0],y:o[1]},h=u[u.length-1],r={x:h[0],y:h[1]},f=Math.atan2(s.x-r.x,s.y-r.y)/Math.PI*180,c={x:r.x+Math.sin(Math.PI/180*(f-15))*20,y:r.y+Math.cos(Math.PI/180*(f-15))*20},l={x:r.x+Math.sin(Math.PI/180*(f+15))*20,y:r.y+Math.cos(Math.PI/180*(f+15))*20};return t.merge(this.createShapeOptions(),{shape:{points:[[r.x,r.y],[c.x,c.y],[l.x,l.y]]},style:{fill:i.getColor(n,a),stroke:n?i.color.TRANSITION_SELECTED_STROKE_COLOR:i.color.TRANSITION_STROKE_COLOR,lineWidth:1,text:""},draggable:e.designable,ondragstart:function(){i.getToAngleTargets().start(e)},ondragend:function(){i.getToAngleTargets().end(e)}})};this.fromAngleTargets=null;this.getFromAngleTargets=function(){return this.fromAngleTargets||(this.fromAngleTargets=new e(this.graph.getActivity(this.from),this,!0))};this.createCircleOptions=function(n){var i=this,r=this.graph,e=r.getActivity(i.from),u=i.fromAngle<1||i.fromAngle>8,f=e.getAnglePosition(u?i.fromAngleRun:i.fromAngle);return t.merge(this.createShapeOptions(),{shape:{cx:f.x,cy:f.y,r:5},style:{fill:i.getColor(n,u),stroke:n?i.color.TRANSITION_SELECTED_STROKE_COLOR:i.color.TRANSITION_STROKE_COLOR,lineWidth:1},draggable:r.designable,ondragstart:function(){i.getFromAngleTargets().start(r)},ondragend:function(){i.getFromAngleTargets().end(r)}})};this.addTo=function(n){var i=this,s=n.transitionDataModel,o=i.createPolylineOptions(!1),u,f,e;o.id+="-polyline";this.polyline=new p(o);n.add(this.polyline);u=i.createArrowOptions(!1);u.id+="-arrow";this.arrow=new h(u);n.add(this.arrow);f=i.createCircleOptions(!1);f.id+="-circle";this.circle=new r(f);n.add(this.circle);e=new s(i);this.data=this.data?t.merge(this.data,e):e};this.remove=function(){this.graph.remove(this.polyline);this.graph.remove(this.arrow);this.graph.remove(this.circle);this.graph.removeTransition(this.id)};this.addMiddlePoint=function(n,t){for(var a,v,r=this.polyline.shape.points,s=r.length,f=-1,h=Number.MAX_VALUE,c=0,i=0;i<s-1;i++){var e=r[i],l=r[i+1],y=Math.sqrt(Math.pow(e[0]-l[0],2)+Math.pow(e[1]-l[1],2)),o=Math.sqrt(Math.pow(e[0]-n,2)+Math.pow(e[1]-t,2));if(o<y){f=i;break}else o<h&&(h=o,c=i)}return f===-1&&(f=c),a=r[0],v=r[s-1],this.middlePoints.splice(f,0,u(a,v,n,t)),f};this.updateMiddlePoint=function(n,t,i){var r=this.polyline.shape.points,f=r[0],e=r[r.length-1],o=u(f,e,t,i);return this.middlePoints[n]=o,this};this.deleteMiddlePoint=function(n){return this.middlePoints.splice(n,1),this};var u=function(n,t,i,r){var u=n[0],f=t[0],e=n[1],o=t[1],h=o-e,c=u-f,a=f*e-u*o,s,l;return fromToLength=Math.sqrt((u-f)*(u-f)+(e-o)*(e-o)),fromXLength=Math.sqrt((u-i)*(u-i)+(e-r)*(e-r)),toXLength=Math.sqrt((f-i)*(f-i)+(o-r)*(o-r)),s=-(h*i+c*r+a)/Math.sqrt(h*h+c*c),l=Math.sqrt(fromXLength*fromXLength-s*s)*(toXLength>fromToLength?-1:1),{v:s/fromToLength,h:l/fromToLength}};this.refresh=function(){function l(i){var r=c[i+1];return{shape:{cx:r[0],cy:r[1],r:5},style:{fill:n.color.TRANSITION_SELECTED_COLOR_UNFIXED,stroke:n.color.TRANSITION_SELECTED_STROKE_COLOR,lineWidth:1},draggable:!0,ondblclick:function(){n.deleteMiddlePoint(i).refresh()},ondragstart:function(){t.onTransitionMiddlePointDragStart(n,i)},ondragend:function(){t.onTransitionMiddlePointDragEnd()}}}var n=this,t=this.graph,i=[],h=n.createPolylineOptions(n.selected),e=n.polyline,o,u,s,f,c;return e.setStyle(h.style),e.setShape(h.shape),i.push(e),o=n.createArrowOptions(n.selected),u=n.arrow,u.setStyle(o.style),u.setShape(o.shape),i.push(u),s=n.createCircleOptions(n.selected),f=n.circle,f.setStyle(s.style),f.setShape(s.shape),i.push(f),n.selected&&n.middlePoints.length>0?(c=n.polyline.shape.points,n.middlePointElements.each(function(n){t.remove(n)}),n.middlePointElements=[],n.middlePoints.each(function(u,f){var e=new r(l(f));t.add(e);n.middlePointElements.push(e);i.push(e)})):(n.middlePointElements.each(function(n){t.remove(n)}),n.middlePointElements=[]),i};this.middlePointElements=[];this.clearMovement=function(){var n=this;return n.polyline.position=[0,0],n.arrow.position=[0,0],n.circle.position=[0,0],n}}function nt(){g.apply(this,arguments);this.choosePolylineStyle=function(){this.subtype==0?(this.polylineStyleLineWidth=3,this.polylineStyleLineDash=null):(this.polylineStyleLineWidth=3,this.polylineStyleLineDash=[5,5])}}function v(n){return new nt(n)}function y(){this.zrClickPosition={x:0,y:0};this.showContextMenu=function(n,t,i){var u;t.style.display="none";t.innerHTML="";u=document.createElement("ul");t.appendChild(u);this.buildContextMenuItems(u,i);var r=-5,f=n.target.clientWidth-n.clientX,e=n.target.clientHeight-n.clientY;t.style.left=f<t.offsetWidth?n.target.scrollLeft+n.offsetX-t.offsetWidth+i.offsetX+r+"px":n.target.scrollLeft+n.offsetX+i.offsetX+r+"px";t.style.top=e<t.offsetHeight?n.target.scrollTop+n.offsetY-t.offsetHeight+i.offsetY+r+"px":n.target.scrollTop+n.offsetY+i.offsetY+r+"px";t.style.display="block";this.zrClickPosition={x:n.zrX,y:n.zrY}};this.buildContextMenuItems=function(n){this.contextMenuItems.forEach(function(t){t.addTo(n)})}}function tt(n){this.options=n;this.text=n.text;this.addTo=function(n){var i=this,r=document.createElement("li"),t;n.appendChild(r);t=document.createElement("a");t.href="javascript:";r.appendChild(t);t.innerText=i.text;t.onclick=function(n){i.onclick(n)}}}function i(n){tt.apply(this,arguments);this.action=n.action;this.unit=n.source;this.onclick=function(n){var t=this.unit.graph,i;switch(this.action){case"add":i={id:t.newGuid(),subtype:2,position:{x:t.zrClickPosition.x+35,y:t.zrClickPosition.y+15},title:"新步骤"};u.appendActivity([i]);break;case"add2":i={id:t.newGuid(),subtype:1,position:{x:t.zrClickPosition.x+45,y:t.zrClickPosition.y+40},title:"新子流程"};u.appendActivity([i]);break;case"clear":u.clear();break;case"join":t.connectActivitys.clear().setType(1).add(this.unit);break;case"remove":this.unit.remove();break;case"setting":if(typeof t.onUnitSetting=="function")t.onUnitSetting(n,this.unit);break;default:console.log(this.unit)}}}function it(n){n=t.merge({id:"00000000-0000-0000-0000-000000000000",subtype:0,position:{x:60,y:60},title:"开始",clickable:!1},n,!0);s.call(this,n)}function rt(n){n=t.merge({id:"00000000-0000-0000-0000-000000000001",subtype:0,position:{x:60,y:60},title:"结束",clickable:!1},n,!0);s.call(this,n)}function ut(){this.position={x:0,y:0};this.width=30;this.height=30;this.createShapeOptions=function(){var n=this;return{tag:"tool",shape:{width:n.width,height:n.height,r:5},style:{fill:"grey",stroke:"#ddd",lineWidth:1,textPosition:"inside",textFill:"#fff",fontSize:28,rectHover:!0}}};this.createEnlargedOptions=function(){var n=this,i=n.createShapeOptions();return t.merge(i,{shape:{x:n.position.x+20,y:n.position.y+20},style:{text:"+"},onclick:function(){n.graph.handleWheel(!0)}})};this.createNarrowOptions=function(){var n=this,i=n.createShapeOptions();return t.merge(i,{shape:{x:n.position.x+20,y:n.position.y+55},style:{text:"-"},onclick:function(){n.graph.handleWheel(!1)}})};this.addTo=function(n){this.graph=n;var t=this,i=t.createEnlargedOptions(),r=t.createNarrowOptions();this.enlarged=new f(i);n.add(this.enlarged);this.narrow=new f(r);n.add(this.narrow)}}function ft(){var n=new w;this.appendActivity=function(t){return t.forEach(function(t){var i=d(t);i.drawTo(n)}),this};this.appendTransition=function(t){return t.forEach(function(t){var i=v(t);i.drawTo(n)}),this};this.getData=function(){var t=n.getActivities().map(function(n){return{id:n.id,title:n.title,type:n.type,subtype:n.subtype,position:n.getCurrentPosition(),data:n.data}}),i=n.getTransitions().map(function(n){return{id:n.id,title:n.title,type:n.type,subtype:n.subtype,from:n.from,fromAngle:n.fromAngle,to:n.to,toAngle:n.toAngle,middlePoints:n.middlePoints,data:n.data}});return{activities:t,transitions:i}};this.getJson=function(){return JSON.stringify(u.getData())};this.getZrenderInstance=function(){return n.zrenderInstance()};this.init=function(t){return n.init(t),this};this.clear=function(){var t,i;return n.clear(),t=new it({position:{x:200,y:n.zrenderInstance().getHeight()*.3}}),t.drawTo(n),i=new rt({position:{x:n.zrenderInstance().getWidth()-200,y:n.zrenderInstance().getHeight()*.3}}),i.drawTo(n),this};this.load=function(t){return t&&(n.clear(),t.activities&&this.appendActivity(t.activities),t.transitions&&this.appendTransition(t.transitions)),this};this.refresh=function(){n.zrenderInstance().resize();n.zrenderInstance().refresh()}}var et=n.color,t=n.util,ot=n.Group,r=n.Circle,f=n.Rect,h=n.Polygon,p=n.Polyline,u=new ft;return u});